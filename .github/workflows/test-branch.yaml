name: Test vs main branch

on: workflow_dispatch

jobs:
#   prepare:
#     runs-on: ubuntu-latest
#     outputs:
#       env_names: ${{ steps.set.outputs.env_names }}
#       test_names: ${{ steps.set.outputs.test_names }}
#     steps:
#       - id: set
#         run: |
#           echo "env_names=['Bullseye', 'Bookworm']" >> $GITHUB_OUTPUT
#           echo "test_names=['Hubbard_N_Leg_Ladder_temper', 'Langevin', 'Langevin_1']" >> $GITHUB_OUTPUT
#     #   - name: Prepare test branch
#     #     run: |
#     #       python3 ./testsuite/test_branch_generate_config.py
#     #       cat generated-config.yml >> $GITHUB_OUTPUT
#     #   - name: Upload generated config artifact
#     #     uses: actions/upload-artifact@v4
#     #     with:
#     #       name: generated-config

  compile:
    # needs: prepare
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/alf-qmc/alf-container/pyalf-requirements/${{ matrix.image_minor[0] }}
    strategy:
      matrix:
        image_minor: 
          - [bullseye, GNU]
          - [bookworm, GNU]
          - [trixie, GNU]
          # - [bullseye-openblas, GNU]
          # - [tumbleweed, GNU]
          - [bullseye-pgi-21-03, PGI]
          - [bookworm-pgi-24-09, PGI]
          - [bullseye-intel, INTEL]
          - [bookworm-intel-2024.2, INTEL]
          - [bookworm-intel, INTELLLVM]
    steps:
      - name: Install pyALF
        run: pip install --no-deps pyALF
      - uses: actions/checkout@v6
        with:
          ref: master
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.test_branch || github.ref_name }}
      - run: alf_test_branch
            --alfdir $PWD
            --sim_pars $PWD/testsuite/test_branch_parameters.json
            --machine ${{ matrix.image_minor[1] }}
            --mpi
            --branch_T ${{ github.event.inputs.test_branch || github.ref_name }}
            --branch_R master
            --devel
            --mpiexec_args="--use-hwthread-cpus"
            # --no_sim
            # --no_analyze
